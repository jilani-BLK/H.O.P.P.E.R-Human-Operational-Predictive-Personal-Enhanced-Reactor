#!/usr/bin/env python3
"""
ğŸ§  HOPPER - Human Operational Predictive Personal Enhanced Reactor
Commande principale pour lancer HOPPER
"""

import sys
import os
import subprocess
import argparse
from pathlib import Path

# Couleurs ANSI
class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

def print_banner():
    """Affiche la banniÃ¨re HOPPER"""
    print(f"{Colors.CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—{Colors.END}")
    print(f"{Colors.CYAN}â•‘                                                           â•‘{Colors.END}")
    print(f"{Colors.CYAN}â•‘          {Colors.GREEN}ğŸ§  H.O.P.P.E.R{Colors.CYAN}                                â•‘{Colors.END}")
    print(f"{Colors.CYAN}â•‘     {Colors.BOLD}Human Operational Predictive Personal{Colors.END}{Colors.CYAN}        â•‘{Colors.END}")
    print(f"{Colors.CYAN}â•‘            {Colors.BOLD}Enhanced Reactor{Colors.END}{Colors.CYAN}                          â•‘{Colors.END}")
    print(f"{Colors.CYAN}â•‘                                                           â•‘{Colors.END}")
    print(f"{Colors.CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Colors.END}")
    print()

def get_project_root():
    """Obtenir la racine du projet"""
    # Le script est dans src/cli/hopper
    script_path = Path(__file__).resolve()
    return script_path.parent.parent.parent

def check_orchestrator_running():
    """VÃ©rifie si l'orchestrateur est en cours d'exÃ©cution"""
    try:
        import requests
        response = requests.get("http://localhost:5050/health", timeout=1)
        return response.status_code == 200
    except:
        return False

def start_orchestrator(project_root):
    """DÃ©marre l'orchestrateur en arriÃ¨re-plan"""
    orchestrator_path = project_root / "src" / "orchestrator" / "main.py"
    venv_python = project_root / "venv" / "bin" / "python"
    
    python_cmd = str(venv_python) if venv_python.exists() else "python"
    
    print(f"{Colors.YELLOW}ğŸš€ DÃ©marrage de l'orchestrateur...{Colors.END}")
    
    # DÃ©marrer en arriÃ¨re-plan
    process = subprocess.Popen(
        [python_cmd, str(orchestrator_path)],
        cwd=str(project_root / "src" / "orchestrator"),
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        start_new_session=True
    )
    
    # Attendre quelques secondes pour le dÃ©marrage
    import time
    for i in range(10):
        time.sleep(0.5)
        if check_orchestrator_running():
            print(f"{Colors.GREEN}âœ… Orchestrateur dÃ©marrÃ© avec succÃ¨s{Colors.END}")
            return True
    
    print(f"{Colors.RED}âŒ Ã‰chec du dÃ©marrage de l'orchestrateur{Colors.END}")
    return False

def launch_tui(project_root, url="http://localhost:5050"):
    """Lance l'interface TUI"""
    tui_path = project_root / "src" / "cli" / "hopper_tui.py"
    venv_python = project_root / "venv" / "bin" / "python"
    
    python_cmd = str(venv_python) if venv_python.exists() else "python"
    
    print(f"{Colors.GREEN}âœ¨ Lancement de l'interface terminal...{Colors.END}")
    print()
    
    # Lancer l'interface TUI
    subprocess.run([python_cmd, str(tui_path), "--url", url])

def show_status(project_root):
    """Affiche le statut de HOPPER"""
    print(f"{Colors.CYAN}ğŸ“Š Statut HOPPER{Colors.END}")
    print(f"{Colors.CYAN}{'â•' * 50}{Colors.END}")
    print()
    
    # VÃ©rifier orchestrateur
    if check_orchestrator_running():
        print(f"ğŸŸ¢ Orchestrateur: {Colors.GREEN}En ligne{Colors.END} (http://localhost:5050)")
        
        # RÃ©cupÃ©rer les stats
        try:
            import requests
            response = requests.get("http://localhost:5050/coordination/stats", timeout=2)
            if response.status_code == 200:
                data = response.json()
                total = data.get("total_modules", 0)
                by_type = data.get("modules_by_type", {})
                
                print(f"ğŸ“¦ Modules: {Colors.BOLD}{total}{Colors.END} coordonnÃ©s")
                print()
                print("   Types de modules:")
                for mod_type, count in by_type.items():
                    print(f"   â€¢ {mod_type}: {count}")
        except:
            pass
    else:
        print(f"ğŸ”´ Orchestrateur: {Colors.RED}Hors ligne{Colors.END}")
        print(f"   {Colors.YELLOW}Lancez avec: hopper start{Colors.END}")
    
    print()

def stop_hopper():
    """ArrÃªte HOPPER"""
    print(f"{Colors.YELLOW}ğŸ›‘ ArrÃªt de HOPPER...{Colors.END}")
    
    # Trouver et tuer les processus
    try:
        result = subprocess.run(
            ["pkill", "-f", "orchestrator/main.py"],
            capture_output=True
        )
        if result.returncode == 0:
            print(f"{Colors.GREEN}âœ… Orchestrateur arrÃªtÃ©{Colors.END}")
        else:
            print(f"{Colors.YELLOW}âš ï¸  Aucun processus HOPPER trouvÃ©{Colors.END}")
    except:
        print(f"{Colors.RED}âŒ Erreur lors de l'arrÃªt{Colors.END}")

def speak_text(project_root, text):
    """Fait parler HOPPER avec sa voix clonÃ©e"""
    if not text:
        print(f"{Colors.RED}âŒ Veuillez fournir un texte Ã  dire{Colors.END}")
        print(f"{Colors.YELLOW}   Exemple: hopper speak \"Bonjour, je suis HOPPER\"{Colors.END}")
        return 1
    
    # Joindre le texte
    full_text = " ".join(text)
    
    print(f"{Colors.CYAN}ğŸ™ï¸  HOPPER dit: {Colors.BOLD}{full_text}{Colors.END}")
    print()
    
    # Utiliser le venv TTS
    venv_tts_python = project_root / "venv_tts" / "bin" / "python"
    
    if not venv_tts_python.exists():
        print(f"{Colors.RED}âŒ Environment TTS non trouvÃ© (venv_tts){Colors.END}")
        print(f"{Colors.YELLOW}   Installez-le avec: python3.11 -m venv venv_tts && venv_tts/bin/pip install TTS{Colors.END}")
        return 1
    
    # CrÃ©er un script temporaire pour gÃ©nÃ©rer et jouer
    temp_script = f"""
import sys
from pathlib import Path
import torch
import subprocess

project_root = Path("{project_root}")
sys.path.insert(0, str(project_root))

# Fix PyTorch 2.9+
original_torch_load = torch.load
def patched_torch_load(*args, **kwargs):
    kwargs['weights_only'] = False
    return original_torch_load(*args, **kwargs)
torch.load = patched_torch_load

try:
    from TTS.api import TTS
except ImportError:
    print("âŒ TTS non installÃ©")
    sys.exit(1)

# Ã‰chantillon vocal
voice_sample_ultra = project_root / "Hopper_voix_ultra_clean.wav"
voice_sample_clean = project_root / "Hopper_voix_clean.wav"
voice_sample_24k = project_root / "Hopper_voix_24k.wav"
voice_sample_hq = project_root / "Hopper_voix_hq.wav"
voice_sample_mp3 = project_root / "Hopper_voix.wav.mp3"

if voice_sample_ultra.exists():
    voice_sample = voice_sample_ultra
elif voice_sample_clean.exists():
    voice_sample = voice_sample_clean
elif voice_sample_24k.exists():
    voice_sample = voice_sample_24k
elif voice_sample_hq.exists():
    voice_sample = voice_sample_hq
elif voice_sample_mp3.exists():
    voice_sample = voice_sample_mp3
else:
    print("âŒ Ã‰chantillon vocal non trouvÃ©")
    sys.exit(1)

# Charger TTS
print("ğŸ“¥ Chargement du modÃ¨le vocal...")
device = "cpu"
tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2").to(device)
print("âœ… PrÃªt\\n")

# GÃ©nÃ©rer
output_file = project_root / "data" / "hopper_speak_temp.wav"
output_file.parent.mkdir(parents=True, exist_ok=True)

print("ğŸ™ï¸  GÃ©nÃ©ration...")
tts.tts_to_file(
    text='''{full_text}''',
    speaker_wav=str(voice_sample),
    language="fr",
    file_path=str(output_file),
    temperature=0.65,
    length_penalty=1.0,
    repetition_penalty=2.5,
    top_k=30,
    top_p=0.75,
    speed=0.9,
    enable_text_splitting=True,
    split_sentences=True
)

print("â–¶ï¸  Lecture...\\n")
subprocess.run(['afplay', str(output_file)])
print("âœ… TerminÃ©")
"""
    
    # ExÃ©cuter le script
    import tempfile
    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
        f.write(temp_script)
        temp_path = f.name
    
    try:
        subprocess.run([str(venv_tts_python), temp_path])
    finally:
        Path(temp_path).unlink()
    
    return 0

def main():
    """Point d'entrÃ©e principal"""
    parser = argparse.ArgumentParser(
        description="ğŸ§  HOPPER - Assistant Personnel Intelligent",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemples:
  hopper              Lance l'interface terminal (dÃ©faut)
  hopper tui          Lance l'interface terminal
  hopper speak "Bonjour, comment allez-vous ?"
  hopper voice "Je suis HOPPER, votre assistant"
  hopper start        DÃ©marre uniquement l'orchestrateur
  hopper status       Affiche le statut
  hopper stop         ArrÃªte HOPPER
        """
    )
    
    parser.add_argument(
        'command',
        nargs='?',
        default='tui',
        choices=['tui', 'start', 'stop', 'status', 'speak', 'voice'],
        help='Commande Ã  exÃ©cuter (dÃ©faut: tui)'
    )
    
    parser.add_argument(
        'text',
        nargs='*',
        help='Texte Ã  faire dire par HOPPER (pour speak/voice)'
    )
    
    parser.add_argument(
        '--url',
        default='http://localhost:5050',
        help='URL de l\'orchestrateur (dÃ©faut: http://localhost:5050)'
    )
    
    parser.add_argument(
        '--no-banner',
        action='store_true',
        help='Ne pas afficher la banniÃ¨re'
    )
    
    args = parser.parse_args()
    
    # Afficher la banniÃ¨re
    if not args.no_banner and args.command not in ['stop', 'status']:
        print_banner()
    
    # Obtenir la racine du projet
    project_root = get_project_root()
    
    # ExÃ©cuter la commande
    if args.command == 'stop':
        stop_hopper()
    
    elif args.command == 'status':
        if not args.no_banner:
            print_banner()
        show_status(project_root)
    
    elif args.command in ['speak', 'voice']:
        return speak_text(project_root, args.text)
    
    elif args.command == 'start':
        # DÃ©marrer uniquement l'orchestrateur
        if check_orchestrator_running():
            print(f"{Colors.GREEN}âœ… Orchestrateur dÃ©jÃ  en cours d'exÃ©cution{Colors.END}")
        else:
            if start_orchestrator(project_root):
                print()
                print(f"{Colors.GREEN}âœ… HOPPER prÃªt !{Colors.END}")
                print(f"   Lancez l'interface avec: {Colors.BOLD}hopper tui{Colors.END}")
    
    elif args.command == 'tui':
        # VÃ©rifier si l'orchestrateur tourne
        if not check_orchestrator_running():
            print(f"{Colors.YELLOW}âš ï¸  Orchestrateur non dÃ©tectÃ©{Colors.END}")
            response = input(f"{Colors.YELLOW}   Voulez-vous le dÃ©marrer? (O/n): {Colors.END}")
            if response.lower() != 'n':
                if not start_orchestrator(project_root):
                    print(f"{Colors.RED}âŒ Impossible de dÃ©marrer l'orchestrateur{Colors.END}")
                    print(f"{Colors.YELLOW}   DÃ©marrez-le manuellement avec: python src/orchestrator/main.py{Colors.END}")
                    return 1
                print()
        
        # Lancer l'interface TUI
        launch_tui(project_root, args.url)
    
    return 0

if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print(f"\n{Colors.YELLOW}ğŸ‘‹ Au revoir !{Colors.END}")
        sys.exit(0)
