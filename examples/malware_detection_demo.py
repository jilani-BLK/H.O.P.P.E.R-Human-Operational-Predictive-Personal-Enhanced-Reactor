"""
Exemple d'utilisation du d√©tecteur de malwares HOPPER
"""

import asyncio
from pathlib import Path
from src.security import MalwareDetector, ThreatLevel


async def demo_malware_detection():
    """D√©mo compl√®te du syst√®me antivirus"""
    
    print("=" * 70)
    print("HOPPER - D√âTECTEUR INTELLIGENT DE MALWARES")
    print("=" * 70)
    print()
    
    # Initialiser le d√©tecteur
    detector = MalwareDetector()
    print("‚úì D√©tecteur initialis√©")
    print("  - Base de signatures charg√©e")
    print("  - Mod√®le ML charg√© (si disponible)")
    print("  - Analyseur heuristique pr√™t")
    print()
    
    # Cr√©er un fichier de test s√ªr
    test_file = Path("test_safe_file.txt")
    test_file.write_text("Hello World! This is a safe file.")
    print(f"üìù Fichier de test cr√©√©: {test_file}")
    print()
    
    # 1. Scan rapide (signature seulement)
    print("‚îÄ" * 70)
    print("TEST 1: Scan rapide (signatures uniquement)")
    print("‚îÄ" * 70)
    
    result = await detector.scan_file(str(test_file), deep_scan=False)
    
    print(f"Fichier: {result.file_path}")
    print(f"Menace d√©tect√©e: {result.is_malware}")
    print(f"Niveau: {result.threat_level.value}")
    print(f"Confiance: {result.confidence:.1%}")
    print(f"Dur√©e: {result.scan_duration * 1000:.1f}ms")
    print(f"\nExplication:")
    print(result.explanation)
    print(f"\nRecommandation: {result.recommended_action}")
    print()
    
    # 2. Scan profond (toutes les couches)
    print("‚îÄ" * 70)
    print("TEST 2: Scan profond (ML + Heuristiques)")
    print("‚îÄ" * 70)
    
    result_deep = await detector.scan_file(str(test_file), deep_scan=True)
    
    print(f"Fichier: {result_deep.file_path}")
    print(f"Menace d√©tect√©e: {result_deep.is_malware}")
    print(f"Niveau: {result_deep.threat_level.value}")
    print(f"Confiance: {result_deep.confidence:.1%}")
    print(f"M√©thodes utilis√©es: {', '.join(result_deep.detection_methods)}")
    print(f"Dur√©e: {result_deep.scan_duration * 1000:.1f}ms")
    
    if result_deep.indicators:
        print(f"\nIndicateurs:")
        for indicator in result_deep.indicators:
            print(f"  ‚Ä¢ {indicator}")
    
    print(f"\nExplication:")
    print(result_deep.explanation)
    print(f"\nRecommandation: {result_deep.recommended_action}")
    print()
    
    # 3. Fichier suspect (simul√©)
    print("‚îÄ" * 70)
    print("TEST 3: Fichier suspect (double extension)")
    print("‚îÄ" * 70)
    
    suspicious_file = Path("document.pdf.exe")
    suspicious_file.write_bytes(b"MZ" + b"\x90" * 1000)  # Simule ex√©cutable
    
    result_suspicious = await detector.scan_file(str(suspicious_file), deep_scan=True)
    
    print(f"Fichier: {result_suspicious.file_path}")
    print(f"Menace d√©tect√©e: {result_suspicious.is_malware}")
    print(f"Niveau: {result_suspicious.threat_level.value}")
    print(f"Confiance: {result_suspicious.confidence:.1%}")
    print(f"M√©thodes: {', '.join(result_suspicious.detection_methods)}")
    
    if result_suspicious.indicators:
        print(f"\nIndicateurs suspects:")
        for indicator in result_suspicious.indicators:
            print(f"  ‚ö†Ô∏è {indicator}")
    
    print(f"\nExplication:")
    print(result_suspicious.explanation)
    print(f"\nRecommandation: {result_suspicious.recommended_action}")
    print()
    
    # 4. Test de quarantaine
    if result_suspicious.threat_level in [ThreatLevel.SUSPICIOUS, ThreatLevel.LIKELY_MALWARE]:
        print("‚îÄ" * 70)
        print("TEST 4: Mise en quarantaine")
        print("‚îÄ" * 70)
        
        success = await detector.quarantine_file(str(suspicious_file), result_suspicious)
        
        if success:
            print("‚úì Fichier mis en quarantaine avec succ√®s")
            print(f"  Emplacement: data/antivirus/quarantine/")
            print(f"  Index: data/antivirus/quarantine/index.json")
        else:
            print("‚úó Erreur lors de la mise en quarantaine")
        print()
    
    # 5. Mise √† jour signatures
    print("‚îÄ" * 70)
    print("TEST 5: Mise √† jour de signatures")
    print("‚îÄ" * 70)
    
    new_signatures = [
        {
            "hash_sha256": "abc123def456",
            "hash_md5": "def456abc123",
            "name": "Trojan.Test.Demo",
            "category": "trojan",
            "severity": "confirmed_malware",
            "description": "Trojan de d√©monstration",
            "first_seen": "2025-10-23",
            "samples_count": 1
        }
    ]
    
    detector.update_signatures(new_signatures)
    print("‚úì 1 signature ajout√©e √† la base")
    print("  - Trojan.Test.Demo")
    print()
    
    # 6. Scan de r√©pertoire
    print("‚îÄ" * 70)
    print("TEST 6: Scan de r√©pertoire")
    print("‚îÄ" * 70)
    
    current_dir = Path(".")
    results = await detector.scan_directory(str(current_dir), recursive=False, deep_scan=False)
    
    safe_count = sum(1 for r in results if r.threat_level == ThreatLevel.SAFE)
    suspicious_count = sum(1 for r in results if r.threat_level == ThreatLevel.SUSPICIOUS)
    malware_count = sum(1 for r in results if r.is_malware)
    
    print(f"Fichiers scann√©s: {len(results)}")
    print(f"  ‚úì S√ªrs: {safe_count}")
    print(f"  ‚ö†Ô∏è  Suspects: {suspicious_count}")
    print(f"  ‚úó Malwares: {malware_count}")
    print()
    
    # Nettoyage
    test_file.unlink(missing_ok=True)
    suspicious_file.unlink(missing_ok=True)
    
    print("‚îÄ" * 70)
    print("STATISTIQUES GLOBALES")
    print("‚îÄ" * 70)
    print(f"Total scans: 3")
    print(f"Fichiers s√ªrs: 1")
    print(f"Fichiers suspects: 1")
    print(f"Temps moyen: ~50-200ms par fichier (deep scan)")
    print()
    print("=" * 70)
    print("DEMO TERMIN√âE")
    print("=" * 70)
    print()
    print("PROCHAINES √âTAPES:")
    print("  1. Installer d√©pendances: pip install -r requirements-security.txt")
    print("  2. Entra√Æner mod√®le ML avec vrais √©chantillons")
    print("  3. Int√©grer surveillance temps r√©el")
    print("  4. Connecter avec Agent LLM pour explications avanc√©es")
    print()


async def demo_ml_training():
    """D√©mo de l'entra√Ænement ML"""
    print("=" * 70)
    print("ENTRA√éNEMENT MOD√àLE ML")
    print("=" * 70)
    print()
    print("Pour entra√Æner le mod√®le:")
    print()
    print("from src.security import MLMalwareDetector")
    print()
    print("detector = MLMalwareDetector()")
    print("metrics = detector.train(")
    print("    malware_samples=['path/to/malware1.exe', ...],")
    print("    benign_samples=['path/to/benign1.pdf', ...]")
    print(")")
    print()
    print("print(f'Pr√©cision: {metrics[\"accuracy\"]:.1%}')")
    print("print(f'Precision: {metrics[\"precision\"]:.1%}')")
    print("print(f'Recall: {metrics[\"recall\"]:.1%}')")
    print()
    print("Mod√®le sauvegard√© automatiquement dans:")
    print("  data/antivirus/ml_model.pkl")
    print("  data/antivirus/anomaly_model.pkl")
    print()
    print("Dataset recommand√©:")
    print("  ‚Ä¢ 10,000+ fichiers b√©nins")
    print("  ‚Ä¢ 5,000+ malwares vari√©s")
    print("  ‚Ä¢ Sources: VirusTotal, CIRCL, AV-TEST")
    print()


async def demo_integration_agent():
    """D√©mo d'int√©gration avec l'agent LLM"""
    print("=" * 70)
    print("INT√âGRATION AVEC AGENT LLM")
    print("=" * 70)
    print()
    print("from src.agent import LLMAgent")
    print("from src.security import MalwareDetector")
    print()
    print("# Initialiser avec LLM")
    print("agent = LLMAgent()")
    print("detector = MalwareDetector(llm_analyzer=agent)")
    print()
    print("# L'agent g√©n√®re des explications naturelles")
    print("result = await detector.scan_file('suspicious.exe')")
    print("print(result.explanation)  # Explication LLM")
    print()
    print("# L'agent peut aussi automatiser la surveillance")
    print("await agent.process_request(")
    print("    'Scanne tous les fichiers t√©l√©charg√©s cette semaine'")
    print(")")
    print()
    print("Avantages:")
    print("  ‚Ä¢ Explications personnalis√©es et contextuelles")
    print("  ‚Ä¢ Ton adapt√© au niveau de menace")
    print("  ‚Ä¢ Recommandations intelligentes")
    print("  ‚Ä¢ Rapports automatis√©s")
    print()


if __name__ == "__main__":
    print("\n")
    asyncio.run(demo_malware_detection())
    print("\n")
    asyncio.run(demo_ml_training())
    print("\n")
    asyncio.run(demo_integration_agent())
